name: Test and Staging Build

on:
  pull_request:
    branches: ["master", "main", "dev"]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: test-staging-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run tests with coverage
        run: flutter test --coverage

      - name: Generate coverage report
        run: |
          # Install lcov if not available
          if ! command -v lcov &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y lcov
          fi
          
          # Generate HTML coverage report
          if [ -f coverage/lcov.info ]; then
            genhtml coverage/lcov.info -o coverage/html || echo "genhtml not available, skipping HTML report"
          fi

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: test-coverage
          path: |
            coverage/lcov.info
            coverage/html/
          if-no-files-found: warn
          retention-days: 30

      - name: Check coverage threshold
        run: |
          if [ -f coverage/lcov.info ]; then
            # Extract coverage percentage (basic check)
            COVERAGE=$(lcov --summary coverage/lcov.info 2>&1 | grep -oP 'lines\.*:\s*\K[\d.]+' | head -1 || echo "0")
            echo "Current test coverage: ${COVERAGE}%"
            # Set minimum threshold (adjust as needed)
            THRESHOLD=0
            # Use awk for comparison (more portable than bc)
            COVERAGE_INT=$(echo "$COVERAGE" | awk '{printf "%.0f", $1}')
            THRESHOLD_INT=$(echo "$THRESHOLD" | awk '{printf "%.0f", $1}')
            if [ "$COVERAGE_INT" -lt "$THRESHOLD_INT" ]; then
              echo "⚠️ Coverage ${COVERAGE}% is below threshold ${THRESHOLD}%"
              # Don't fail for now, just warn
            else
              echo "✅ Coverage ${COVERAGE}% meets threshold ${THRESHOLD}%"
            fi
          else
            echo "⚠️ Coverage file not found"
          fi

  build-android-staging:
    needs: test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Build Android APK (debug/staging)
        run: flutter build apk --debug --no-tree-shake-icons

      - name: Upload Android staging APK
        uses: actions/upload-artifact@v4
        with:
          name: android-staging-apk
          path: build/app/outputs/flutter-apk/app-debug.apk
          if-no-files-found: error
          retention-days: 7

      # Optional: Deploy to Firebase App Distribution (staging)
      - name: Firebase App Distribution (staging) (optional)
        env:
          FIREBASE_APP: ${{ secrets.FIREBASE_APP_ID }}
          FIREBASE_TOK: ${{ secrets.FIREBASE_TOKEN }}
        if: env.FIREBASE_APP != '' && env.FIREBASE_TOK != ''
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID }}
          token: ${{ secrets.FIREBASE_TOKEN }}
          file: build/app/outputs/flutter-apk/app-debug.apk
          testers: ${{ secrets.FIREBASE_TESTERS }}
          groups: ${{ secrets.FIREBASE_STAGING_GROUPS || 'staging' }}

  build-ios-staging:
    needs: test
    runs-on: macos-latest
    # Note: iOS builds require macOS runners and proper code signing setup
    continue-on-error: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Install CocoaPods
        run: |
          cd ios
          pod install

      - name: Install Apple certificate and provisioning profile
        env:
          P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
          P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
          PROVISION_PROFILE_BASE64: ${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
        if: env.P12_BASE64 != ''
        run: |
          set -euo pipefail

          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          echo "$P12_BASE64" | base64 --decode -o $CERTIFICATE_PATH
          echo "$PROVISION_PROFILE_BASE64" | base64 --decode -o $PP_PATH

          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles/

          echo "✅ Certificate and provisioning profile installed"

      - name: Build IPA (staging)
        env:
          P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
        run: |
          if [ -n "${P12_BASE64:-}" ]; then
            flutter build ipa --release --no-tree-shake-icons
          else
            echo "⚠️ No signing secrets configured, building unsigned"
            flutter build ios --debug --no-codesign --no-tree-shake-icons
          fi
        continue-on-error: true

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-staging-ipa
          path: build/ios/ipa/*.ipa
          if-no-files-found: warn
          retention-days: 7

      - name: Upload unsigned build (fallback)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-staging-build
          path: |
            build/ios/iphoneos/Runner.app
            build/ios/Debug-iphoneos/
          if-no-files-found: warn
          retention-days: 7

      - name: Clean up keychain
        if: always()
        run: |
          if [ -f "$RUNNER_TEMP/app-signing.keychain-db" ]; then
            security delete-keychain $RUNNER_TEMP/app-signing.keychain-db
          fi

      - name: Note about iOS builds
        if: failure()
        run: |
          echo "⚠️ iOS IPA build requires these GitHub secrets:"
          echo "  - IOS_P12_BASE64: Base64-encoded .p12 distribution certificate"
          echo "  - IOS_P12_PASSWORD: Password for the .p12 file"
          echo "  - IOS_PROVISION_PROFILE_BASE64: Base64-encoded .mobileprovision file"
          echo "  - IOS_KEYCHAIN_PASSWORD: Any password for the temporary keychain"

  build-web-staging:
    needs: test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Build Web
        run: flutter build web --release --no-tree-shake-icons

      - name: Upload Web build
        uses: actions/upload-artifact@v4
        with:
          name: web-staging-build
          path: build/web/
          if-no-files-found: error
          retention-days: 7

      # Optional: Deploy to Firebase Hosting (staging)
      - name: Deploy to Firebase Hosting (staging) (optional)
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        if: env.FIREBASE_TOKEN != ''
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
          channelId: staging
          projectId: ${{ secrets.FIREBASE_PROJECT_ID }}
          target: ${{ secrets.FIREBASE_HOSTING_TARGET || 'default' }}
