AI_CONTEXT — Digital Vision Board (Flutter)
Last updated: 2026-02-20
Updated: Rewrote to only include features that are actually visible/reachable in the current UI. Removed references to unreachable screens (VisionBoardHomeScreen flip-card landing, Reminders sheet, Affirmation tab, Todos tab, old wizard steps). Added new visible features: 75 Hard Challenge, Subscription, Backup/Restore, Onboarding, Mood tracking, Earn Badges, Ads system.

This document is optimized for AI + human onboarding. It describes only features that are visible and reachable in the current build.

---

## 1) What the app does (product mental model)

Digital Vision Board is a habit-tracking and personal growth app. Users create habits, track completions with gamified coins, run timed routines, journal, solve puzzles from goal images, and visualize progress on vision boards.

Daily loop:
- Open the app → Dashboard (Home tab)
- Complete habits (earn coins)
- Run routines (timed step-by-step workflows)
- Journal, review insights, do puzzles

---

## 2) App entry and navigation structure

### Entry
- `lib/main.dart` → `home:` is `OnboardingScreen` (new users) or `DashboardScreen` (existing users)
- No named routes; all navigation is push-based (`MaterialPageRoute`)

### Dashboard screen (main hub)
- **Screen**: `lib/screens/dashboard_screen.dart`
- **Body**: `lib/widgets/dashboard/dashboard_body.dart` switches content by tab index

### Bottom navigation (4 tabs + center FAB)

| Nav index | Tab index | Label   | Content |
|-----------|-----------|---------|---------|
| 0         | 1         | Home    | `DashboardTab` — summary cards grid |
| 1         | 7         | Habits  | `AllBoardsHabitsTab` — gamified habit list with coins |
| 2         | 6         | Routine | `RoutineScreen` — sun times, date selector, routine timeline |
| 3         | 2         | Journal | `JournalNotesScreen(embedded: true)` — journal entries |

- `visibleTabIndices = [1, 7, 6, 2]` (line 996 of dashboard_screen.dart)
- Nav bar: `lib/widgets/navigation/animated_bottom_nav_bar.dart`

### Center FAB "+" → Create panel
Slides up from bottom, shows three options:
- **New Habit** → `showAddHabitModal()` (4-step wizard)
- **New Routine** → `showAddHabitModal(initialTimerEnabled: true)`
- **75 Hard Challenge** → `ChallengeSetupScreen` (ad-gated)

### App bar
- **Left**: Profile avatar → opens drawer
- **Center**: User name + time-of-day greeting
- **Right**: Coin badge (tap → `EarnBadgesScreen`)

### Drawer (hamburger)
| Item | Screen | File |
|------|--------|------|
| Profile header | `AuthGatewayScreen` | `lib/screens/auth/auth_gateway_screen.dart` |
| Go Premium | `SubscriptionScreen` | `lib/screens/subscription_screen.dart` |
| Backup | `BackupRestoreScreen` | `lib/screens/backup_restore_screen.dart` |
| Widget Guide | `WidgetGuideScreen` | `lib/screens/widget_guide_screen.dart` |
| App Tour | `OnboardingScreen(replayMode: true)` | `lib/screens/onboarding/onboarding_screen.dart` |
| Privacy Policy | `PrivacyPolicyScreen` | `lib/screens/privacy_policy_screen.dart` |
| Sign out | Signs out, creates guest session | (only shown for non-guest users) |

---

## 3) Home tab (DashboardTab) — summary cards

**File**: `lib/widgets/dashboard/dashboard_tab.dart`

Layout: scrollable column of cards:

| Card | File | Tap action |
|------|------|------------|
| ChallengeProgressCard | `challenge_progress_card.dart` | Empty: → `ChallengeSetupScreen`; Active: → switch to Habits tab |
| InsightsSummaryCard | `insights_summary_card.dart` | → `GlobalInsightsScreen` (wrapped in Scaffold) |
| MoodTrackerCard | `mood_tracker_card.dart` | → `MoodDetailScreen` |
| VisionBoardSummaryCard | `vision_board_summary_card.dart` | → `VisionBoardsScreen` (board carousel) |
| PuzzleSummaryCard | `puzzle_summary_card.dart` | → `PuzzleGameScreen` (picks image if none) |
| AffirmationSummaryCard | `affirmation_summary_card.dart` | → `AffirmationManagementScreen`; flips between affirmations when they exist |

All card files are in `lib/widgets/dashboard/`.

---

## 4) Vision Boards flow

### VisionBoardsScreen (from Manifest card on Home tab)
- **File**: `lib/screens/vision_boards_screen.dart`
- Board carousel with swipe navigation
- Actions: Tap board → open viewer; Edit button → open editor; Delete; "+" → `CreateBoardWizardScreen`

### Board types

**A) Grid Board (structured tile layout)**
- Editor: `lib/screens/grid_board_editor.dart` (exported via `lib/screens/grid_editor.dart`)
- Tap tile → `GridGoalViewerScreen` → full-screen `HabitTrackerSheet`
- Storage: `lib/services/grid_tiles_storage_service.dart`

**B) Goal Canvas (freeform layers over background)**
- Viewer: `lib/screens/goal_canvas_viewer_screen.dart`
- Editor: `lib/screens/goal_canvas_editor_screen.dart`
- Tap goal → opens `HabitTrackerSheet` as bottom sheet
- Storage: `lib/services/vision_board_components_storage_service.dart`
- Layers UI: `lib/widgets/editor/layers_sheet.dart` → `showLayersSheet()`

### Create board flow
- `CreateBoardWizardScreen` (`lib/screens/wizard/create_board_wizard_screen.dart`)
  - Creates a board with a single "Hero" grid tile, optionally preloads Pexels image
  - Immediately pushes `GridEditorScreen` for the new board

### HabitTrackerSheet (per-goal tracker)
- **File**: `lib/widgets/habit_tracker_sheet.dart`
- Tabs: Tracker (habits), Tasks (tasks + checklists), Insights
- Used as bottom sheet from GoalCanvasViewerScreen, full-screen body in GridGoalViewerScreen

---

## 5) Habits tab (AllBoardsHabitsTab)

**File**: `lib/widgets/dashboard/all_boards_habits_tab.dart`

Shows all habits across all boards with gamified UI:
- `DailyProgressHeader` — daily progress + coin balance
- `AnimatedHabitCard` — gradient cards with coin badge, streak indicator, weekly progress
- Habit completion → `HabitCompletionSheet` → choose coping plan (5 coins) or full habit (10 coins)
- Coin animation overlay on completion
- Ad unlock flow for free users (3+ habits gated)

### Coins/Gamification System
- **Service**: `lib/services/coins_service.dart`
- Awards: 5 coins (coping plan), 10 coins (full habit), 25 coins (7-day streak bonus)
- UI: `lib/widgets/rituals/daily_progress_header.dart`, `animated_habit_card.dart`, `coin_animation_overlay.dart`, `habit_completion_sheet.dart`

### EarnBadgesScreen
- **File**: `lib/screens/earn_badges_screen.dart`
- Accessed from: coin badge in Dashboard app bar
- Shows: coin balance, badge grid, "Go Ad-Free" redemption card

---

## 6) Routine tab (RoutineScreen)

**File**: `lib/screens/routine_screen.dart` (tab index 6)

- Sun times header with sunrise/sunset arc visualization
- Date selector to view routines by date
- Timeline view of routines sorted by start time
- Tap routine → `RoutineTimerScreen`

### RoutineTimerScreen
- **File**: `lib/screens/routine_timer_screen.dart`
- Circular countdown timer, PageView for steps
- Per-step completion with confetti
- Timer modes: "Flexible Flow" (overall) or "Guided Steps" (per-step)

### Data Models
- `Routine` (`lib/models/routine.dart`): title, icon, todos, timeMode, schedule
- `RoutineTodoItem` (`lib/models/routine_todo_item.dart`): step with duration, reminder, completion dates
- Storage: `lib/services/routine_storage_service.dart`

### Sun Times
- **Service**: `lib/services/sun_times_service.dart` (NOAA calculator, geolocator)
- **Widget**: `lib/widgets/routine/sun_times_header.dart` (arc visualization)

---

## 7) Journal tab

**File**: `lib/screens/journal/journal_notes_screen.dart` (embedded mode, tab index 2)

Journal with editor:
- `lib/screens/journal/journal_editor_screen.dart`
- Supporting widgets in `lib/screens/journal/widgets/`: book carousel, hero section, action bar, editor components, image/audio embeds, font picker, cover chooser

---

## 8) 75 Hard Challenge

### ChallengeSetupScreen
- **File**: `lib/screens/challenge_setup_screen.dart`
- Preview challenge template, set start date, customize habit names/times/durations
- "Start Challenge" creates habits and challenge record
- Ad-gated for free users

### ChallengeProgressCard
- **File**: `lib/widgets/dashboard/challenge_progress_card.dart`
- Shows on Home tab: progress when active, start prompt when inactive
- Active challenge tap → switch to Habits tab

### Storage
- `ChallengeStorageService` — challenge records
- `HabitStorageService` — habits created by challenge

---

## 9) Puzzle Game

### PuzzleGameScreen
- **File**: `lib/screens/puzzle_game_screen.dart`
- 4x4 drag-and-drop puzzle from goal images
- Completion detection, solve timer, reference image toggle, shuffle
- Image selector: `lib/widgets/dialogs/puzzle_image_selector_sheet.dart`

### PuzzleService
- **File**: `lib/services/puzzle_service.dart`
- Auto-rotates puzzle image every 4 hours
- Falls back to gallery picker if no goal images exist

### Image Splitter
- **File**: `lib/utils/puzzle_image_splitter.dart` (splits into 16 pieces)

---

## 10) Affirmations

### AffirmationManagementScreen
- **File**: `lib/screens/affirmation_management_screen.dart`
- Accessed from: AffirmationSummaryCard on Home tab
- CRUD for affirmations, pin/unpin

### AffirmationService
- **File**: `lib/services/affirmation_service.dart`
- Backend API: `/api/affirmations` (CRUD + pin, requires dvAuth)

---

## 11) Mood Tracking

### MoodDetailScreen
- **File**: `lib/screens/mood_detail_screen.dart`
- Accessed from: MoodTrackerCard on Home tab

---

## 12) Insights

### GlobalInsightsScreen
- **File**: `lib/screens/global_insights_screen.dart`
- Accessed from: InsightsSummaryCard on Home tab
- Per-board or all-boards activity/streak summaries

---

## 13) Auth and Account

### AuthGatewayScreen
- **File**: `lib/screens/auth/auth_gateway_screen.dart`
- Accessed from: drawer profile header
- Auth methods: Google Sign-In, Guest Sign-In
- Sub-screens: `ProfileCompletionScreen` (profile editing)

### Auth Service
- **File**: `lib/services/dv_auth_service.dart`
- Guest tokens (10-day expiry), Firebase exchange
- Backend: `POST /auth/guest`, `POST /auth/firebase/exchange`

---

## 14) Subscription and Ads

### SubscriptionScreen
- **File**: `lib/screens/subscription_screen.dart`
- Accessed from: drawer "Go Premium"

### Ad System
- `AdService` / `AdFreeService` — gates habit creation (3+ free limit) and challenge setup
- Free users see ad cards on Habits tab; watch 5 ads to unlock habit slot
- Premium users bypass all ad gates

---

## 15) Backup and Restore

### BackupRestoreScreen
- **File**: `lib/screens/backup_restore_screen.dart`
- Accessed from: drawer "Backup"
- Google Drive backup with encryption
- `GoogleDriveBackupService`, `AutoSyncService`

---

## 16) Onboarding

### OnboardingScreen
- **File**: `lib/screens/onboarding/onboarding_screen.dart`
- Shown on first launch; replayable from drawer "App Tour"

---

## 17) Core data model

### HabitItem
- **File**: `lib/models/habit_item.dart`
- Completion dates, streaks, weekly schedule, time-bound specs, location triggers, habit anchoring

### Standalone Habit Storage
- **File**: `lib/services/habit_storage_service.dart`
- Habits stored independently (not on board components) for the Habits tab
- Synced with board component habits via `syncComponentsHabits()`

### VisionComponent / ImageComponent
- **Files**: `lib/models/vision_component.dart`, `lib/models/image_component.dart`, `lib/models/vision_components.dart`
- Nodes on freeform canvases; own habits and tasks lists

### GridTileModel
- **File**: `lib/models/grid_tile_model.dart`
- Grid board tiles; own goal, habits, tasks

### TaskItem + ChecklistItem
- **File**: `lib/models/task_and_checklist_models.dart`
- Tasks with checklists; per-day completion feedback

### VisionBoardInfo
- **File**: `lib/models/vision_board_info.dart`
- Board metadata (id, title, layoutType, coreValueId, templateId)

### Routine + RoutineTodoItem
- **Files**: `lib/models/routine.dart`, `lib/models/routine_todo_item.dart`

---

## 18) Persistence

| Data | Service | Storage |
|------|---------|---------|
| Boards list | `BoardsStorageService` | SharedPreferences |
| Grid tiles | `GridTilesStorageService` | SharedPreferences (by boardId) |
| Canvas components | `VisionBoardComponentsStorageService` | SharedPreferences (by boardId) |
| Standalone habits | `HabitStorageService` | SharedPreferences |
| Routines | `RoutineStorageService` | SharedPreferences |
| Coins | `CoinsService` | SharedPreferences (`user_total_coins`) |
| Challenges | `ChallengeStorageService` | SharedPreferences |
| Puzzle state | `PuzzleService` | SharedPreferences |
| Auth tokens | `DvAuthService` | SharedPreferences (`dv_auth_token_v1`) |

---

## 19) Completion semantics and feedback

### Habit completion
- Weekly scheduled habits can only be toggled on scheduled dates
- Completion → feedback prompt (mood rating + note)

### Checklist item completion
- Check item → prompt for feedback if missing today
- If that check completes the task → prompt for task-level feedback
- Single-item tasks: skip item-level feedback, only show task-level

### Shared implementation
- Completion applier: `lib/services/habit_completion_applier.dart`
- Feedback UI: `lib/widgets/dialogs/completion_feedback_sheet.dart`
- Implemented consistently in: `habit_tracker_sheet.dart`, `tasks_list_screen.dart`, `all_boards_habits_tab.dart`, `habits_list_screen.dart`, `all_boards_tasks_tab.dart`

---

## 20) Add Habit Modal (4-step wizard)

**File**: `lib/widgets/rituals/add_habit_modal.dart`

Steps:
1. Name & Icon (text input + icon picker)
2. Color (gradient color picker)
3. Schedule (occurrence, weekdays, interval, time, reminders)
4. Advanced (duration/timer, habit anchoring, location triggers, CBT)

Called via `showAddHabitModal()` from create panel and other flows.

---

## 21) Typography and Theme System

### Typography
- **File**: `lib/utils/app_typography.dart`
- `AppTypography.heading1/2/3`, `body`, `bodySmall`, `caption`, `button`, `secondary`, `error`
- All styles are theme-aware (adapt to light/dark)

### Theme Colors
- Material 3 with `ColorScheme.fromSeed(seedColor: Colors.deepPurple)`
- Never use hardcoded colors; always use `Theme.of(context).colorScheme.*`
- Key mappings: `onSurface` (primary text), `onSurfaceVariant` (secondary text), `outline` (borders), `primary` (actions)

### App Colors
- **File**: `lib/utils/app_colors.dart`
- `AppColors.skyGradient()` for dashboard background, `AppColors.coinGold` for coin UI

---

## 22) Platform / web-safe file access

- **File**: `lib/utils/file_image_provider.dart`
- `fileExists(path)` — platform-safe; returns false on web
- `fileImageProviderFromPath(path)` — returns `FileImage` on mobile, `NetworkImage` for URLs, null for file paths on web
- Used throughout board editors and viewers for cross-platform image display

---

## 23) Backend API

Base URL: `DvAuthService.backendBaseUrl()` (default `https://digital-vision-board.onrender.com`)
Auth: `Authorization: Bearer <dvToken>` for protected routes

| Method | Path | Auth | Purpose |
|--------|------|------|---------|
| GET | `/health` | — | Health check |
| GET | `/privacy-policy` | — | HTML privacy page |
| GET | `/stock/pexels/search` | — | Pexels image proxy |
| GET | `/stock/category-images` | — | Category images (DB cache) |
| GET | `/wizard/defaults` | — | Core values + categories |
| GET | `/wizard/recommendations` | — | Goal recommendations |
| POST | `/wizard/recommendations/generate` | — | Generate recommendations (Gemini) |
| POST | `/auth/guest` | — | Create guest session |
| POST | `/auth/firebase/exchange` | — | Firebase → dvToken |
| GET | `/templates` | dvAuth | List templates |
| GET | `/templates/:id` | dvAuth | Get template |
| GET | `/sync/bootstrap` | dvAuth | Bootstrap empty app |
| POST | `/sync/push` | dvAuth | Push local changes |
| PUT | `/user/settings` | dvAuth | Update timezone/gender |
| GET | `/api/affirmations` | dvAuth | List affirmations |
| POST | `/api/affirmations` | dvAuth | Create affirmation |
| PUT | `/api/affirmations/:id` | dvAuth | Update affirmation |
| DELETE | `/api/affirmations/:id` | dvAuth | Delete affirmation |
| PUT | `/api/affirmations/:id/pin` | dvAuth | Pin/unpin |

---

## 24) Build Configuration

- **Icon Tree-Shaking**: Uses `--no-tree-shake-icons` for dynamic IconData
- **Environment Variables**: See `ENV_SETUP.md` (GEMINI_API_KEY, PEXELS_API_KEY, etc.)

---

## 25) Stability gotchas

### A) TextEditingController + dialogs
Don't create a controller outside a dialog and dispose after `await showDialog`. Return values via dialog result instead.

### B) Checklist uncheck bug
`ChecklistItem.copyWith` uses sentinel pattern to allow explicitly clearing `completedOn` (null pass-through).

### C) Avoid duplicate symbols
Keep shared dialogs/services single-defined.

### D) Web vs. file system
Use `lib/utils/file_image_provider.dart` helpers instead of `dart:io` File directly.

---

## 26) Quick entry points

- App entry: `lib/main.dart`
- Dashboard: `lib/screens/dashboard_screen.dart`; body: `lib/widgets/dashboard/dashboard_body.dart`
- Home tab cards: `lib/widgets/dashboard/dashboard_tab.dart`
- Habits tab: `lib/widgets/dashboard/all_boards_habits_tab.dart`
- Routine tab: `lib/screens/routine_screen.dart`; timer: `lib/screens/routine_timer_screen.dart`
- Journal tab: `lib/screens/journal/journal_notes_screen.dart`
- Vision boards: `lib/screens/vision_boards_screen.dart`
- Grid board: `lib/screens/grid_board_editor.dart`, `lib/screens/grid_goal_viewer_screen.dart` (not a standalone file — is `GridGoalViewerScreen` in the grid editor)
- Goal canvas: `lib/screens/goal_canvas_viewer_screen.dart`, `lib/screens/goal_canvas_editor_screen.dart`
- Tracker: `lib/widgets/habit_tracker_sheet.dart`
- Habit modal: `lib/widgets/rituals/add_habit_modal.dart`
- Puzzle: `lib/screens/puzzle_game_screen.dart`
- Challenge: `lib/screens/challenge_setup_screen.dart`
- Affirmations: `lib/screens/affirmation_management_screen.dart`
- Mood: `lib/screens/mood_detail_screen.dart`
- Insights: `lib/screens/global_insights_screen.dart`
- Badges: `lib/screens/earn_badges_screen.dart`
- Auth: `lib/screens/auth/auth_gateway_screen.dart`
- Subscription: `lib/screens/subscription_screen.dart`
- Backup: `lib/screens/backup_restore_screen.dart`
- Onboarding: `lib/screens/onboarding/onboarding_screen.dart`
- Create board wizard: `lib/screens/wizard/create_board_wizard_screen.dart`

---

## 27) Glossary

- **Board**: `VisionBoardInfo` — a vision board with goals
- **Goal**: Metadata on an ImageComponent or GridTileModel
- **Habit**: `HabitItem` — daily/weekly trackable; stored standalone or on goals
- **Task**: `TaskItem` with `ChecklistItem` children
- **Routine**: `Routine` with `RoutineTodoItem` steps — timed workflows
- **Challenge**: 75 Hard program — creates habits with specific schedule
- **Coins**: Gamification currency earned from habit completions
- **Tracker**: `HabitTrackerSheet` — per-goal habit/task/insights UI
