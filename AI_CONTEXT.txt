AI_CONTEXT — Digital Vision Board (Flutter)
Last updated: 2026-02-01
Updated: Added section 19 (Backend API and app integration)—current endpoints, auth, and Flutter service mapping; Restructured by feature visibility; Vision board editor web-safe file access; Corrected completion feedback and add-task/todo flows; Fixed duplicate section numbering.

This document is optimized for AI + human onboarding. It explains what the app does, where data lives, and how the main workflows are implemented in code.

---

## 1) What the app does (product mental model)

Digital Vision Board lets users create “boards” and attach “goals” to them. Each goal can have:
- Habits (daily/weekly scheduled completion tracking)
- Tasks (each task has a checklist; checklist items can be completed per-day and can store completion feedback)

Daily loop:
- Open a board
- Open a goal
- Check off habits/tasks (optionally leave a rating + note)
- Review progress/insights

---

## 1.5) Feature visibility and entry points (what the user sees → code)

### App entry and home
- **Entry**: `lib/main.dart` → `VisionBoardHomeScreen` (`lib/screens/vision_board_home_screen.dart`)
- **Home**: If no boards → navigate to Dashboard. If boards exist → flip-card view of active board; tap "All boards" → Dashboard.

### Dashboard screen (main hub)
- **Screen**: `lib/screens/dashboard_screen.dart`
- **Body**: `lib/widgets/dashboard/dashboard_body.dart` switches by tab index.

**Bottom navigation (4 tabs):**
| Tab        | Label       | Content |
|-----------|-------------|---------|
| tabIndex 1 | Dashboard  | `DashboardTab`: board list (VisionBoardPreviewCard), routines, PuzzleWidget, FAB (create board / create routine) |
| tabIndex 2 | Journal    | `JournalNotesScreen` (embedded) |
| tabIndex 3 | Affirmations | `AffirmationScreen` |
| tabIndex 4 | Insights   | `GlobalInsightsScreen` (per-board or all boards) |

**Drawer (hamburger):**
- User profile → `AuthGatewayScreen`
- Notifications → Reminders sheet (from `ReminderSummaryService`)
- Settings → `SettingsScreen`
- Puzzle Game → `PuzzleGameScreen`
- Widget Guide → `WidgetGuideScreen`

**Create board flow:** FAB or "New" → template picker sheet → either:
- Browse templates → `TemplateGalleryScreen`
- Create with wizard → `CreateBoardWizardScreen`
- Or direct → `showNewBoardDialog` then `GoalCanvasEditorScreen` / `GridEditorScreen` (by layout type)

**Open board:** Tap board card → `_openBoard()`: routes by layout and components to Grid editor or Goal canvas viewer/editor.

**Routines:** Shown on Dashboard tab; create → `RoutineEditorScreen`; open → `RoutineTimerScreen`.

### Other visible screens (from drawer or navigation)
- Auth: `AuthGatewayScreen`, `LoginScreen`, `SignupScreen`, `PhoneAuthScreen`
- Settings: `SettingsScreen`; Music provider → `MusicProviderSettingsScreen`; Spotify selection → `SpotifySelectionScreen`
- Templates: `TemplateGalleryScreen`
- Wizard: `CreateBoardWizardScreen` + step screens in `lib/screens/wizard/`
- Puzzle: `PuzzleGameScreen` (also deep link from home)
- Widget guide: `WidgetGuideScreen`
- Journal: `JournalNotesScreen`; Affirmations: `AffirmationScreen`; Insights: `GlobalInsightsScreen`
- Per-board habits/todos lists: `HabitsListScreen`, `TodosListScreen` (opened from dashboard when a board is selected; tab 5 in body is used for todos/insights with board context)
- Daily overview: `DailyOverviewScreen` (if used elsewhere)
- Admin: `templates_admin_screen.dart` (admin only)

### Platform / web-safe file access
- **File paths and images (web + mobile):** Use `lib/utils/file_image_provider.dart`:
  - `fileExists(String path)` — platform-safe; on web returns false.
  - `fileImageProviderFromPath(String path)` — returns `FileImage` on io, `NetworkImage` for URLs, null for file paths on web.
- Vision board editor and grid flows use these so the same code compiles on web and mobile without `dart:io`/`dart:html` File conflicts.

---

## 2) Board types (UIs) and how they map to storage

There are multiple board “canvas” experiences. They differ in how goals are represented and how they are stored.

### A) Goal Canvas (freeform layers over optional background)
- Viewer: `lib/screens/goal_canvas_viewer_screen.dart`
- Editor: `lib/screens/goal_canvas_editor_screen.dart`
- Storage: `lib/services/vision_board_components_storage_service.dart`
- Supports “Layers” UI via `showLayersSheet` (see section 6)

### B) Grid Board (structured tile layout)
- Editor: `lib/screens/grid_board_editor.dart`
- Storage: `lib/services/grid_tiles_storage_service.dart` (tiles keyed by boardId)
- Single “goal” viewer: `lib/screens/grid_goal_viewer_screen.dart`

---

## 3) Core data model (what “goal”, “habit”, “task” mean in code)

### VisionComponent (core “node”)
`VisionComponent` is the base type for nodes on freeform canvases.
- Location/size/z-index exist for visuals.
- It also owns the tracker data:
  - `habits: List<HabitItem>`
  - `tasks: List<TaskItem>`

Key files:
- `lib/models/vision_component.dart` (base)
- `lib/models/vision_component_factory.dart` (JSON deserialization)
- `lib/models/vision_components.dart` (exports concrete components)
- `lib/models/image_component.dart` (image goal layer; often has `goal` metadata)

### GridTileModel
Grid boards don’t store `VisionComponent`s directly. They store tiles:
- `lib/models/grid_tile_model.dart`
- Each tile can have: `goal`, `habits`, `tasks`

For tracking UI, `GridGoalViewerScreen` converts a tile into an `ImageComponent` (see section 5).

### HabitItem
`lib/models/habit_item.dart`
- Tracks completion dates / streaks
- Supports weekly schedule gating (`isScheduledOnDate`)
- Stores per-day completion feedback (see below)
- Optional `timeBound: HabitTimeBoundSpec` for timer-based habits
  - Supports two modes: `'time'` (time-based) or `'song'` (song-based)
  - For song-based mode, `duration` represents target number of songs

### TaskItem + ChecklistItem
`lib/models/task_item.dart`
- `TaskItem` owns:
  - `checklist: List<ChecklistItem>`
  - optional task-level completion feedback by date (`completionFeedbackByDate`)
- `ChecklistItem` owns:
  - `completedOn` (YYYY-MM-DD) when checked
  - `feedbackByDate` (per-day checklist-item completion feedback)
  - optional `dueDate` and optional CBT enhancements

Important bug fix: `ChecklistItem.copyWith` uses a sentinel so callers can explicitly clear nullable fields like `completedOn` (unchecking).

---

## 4) Persistence (where data is saved)

### Boards list + board metadata
- `lib/services/boards_storage_service.dart`

### Components (goal canvas boards)
- `lib/services/vision_board_components_storage_service.dart`
- Components are JSON encoded and stored keyed by `boardId`.

### Grid tiles
- `lib/services/grid_tiles_storage_service.dart`
- Tiles are JSON encoded and stored keyed by `boardId`.

---

## 5) The tracker UI: HabitTrackerSheet

Main tracker UI:
- `lib/widgets/habit_tracker_sheet.dart`

Usage patterns:
- Shown as a bottom sheet from viewers (Goal canvas viewer).
- Embedded full-screen in `GridGoalViewerScreen` as the whole page body.

Tabs:
- Tracker (habits list)
- Tasks (tasks list + checklist)
- Insights (activity/streak summaries)

It emits updated `VisionComponent` back to the caller via `onComponentUpdated`, and callers persist the updated component list/tile.

---

## 6) Layers UI (showLayersSheet)

Shared “Layers” bottom sheet:
- `lib/widgets/editor/layers_sheet.dart` → `showLayersSheet(...)`

Where it’s used:
- Goal canvas viewer: `GoalCanvasViewerScreen._showLayers` (AppBar button on Canvas tab)
- Grid goal viewer: `GridGoalViewerScreen._showLayers` (top-right overlay button)
  - used to jump between tile-goals without backing out

Selection behavior:
- Selecting a layer updates the viewer’s selected id (highlights it visually).

---

## 7) Rhythmic Timer (Time-Based and Song-Based Modes)

The app supports two timer modes for habits:

### Time-Based Mode
- Traditional timer that tracks accumulated time
- Uses `HabitTimerStateService` for state persistence
- UI: `lib/screens/habit_timer_screen.dart` (existing)
- When target time is reached, automatically marks habit as complete

### Song-Based Mode
- Tracks songs played via music providers (Spotify/Apple Music) or fallback audio player
- Uses `RhythmicTimerService` and `RhythmicTimerStateService` for state management
- Key files:
  - `lib/services/rhythmic_timer_service.dart` - Main service managing timer modes
  - `lib/services/rhythmic_timer_state_service.dart` - State persistence (songsRemaining, currentSongTitle)
  - `lib/services/music_provider_service.dart` - Abstract interface for music providers
  - `lib/models/rhythmic_timer_config.dart` - Configuration model
  - `lib/screens/rhythmic_timer_screen.dart` - UI screen supporting both modes
  - `lib/widgets/rhythmic_timer_widget.dart` - Compact widget for embedding

### Music Provider Integration
- **Spotify**: `SpotifyProvider` in `lib/services/music_provider_service.dart`
  - OAuth integration via backend API (`/api/spotify/*` endpoints)
- **YouTube Music**: `YouTubeMusicProvider` (similar to Spotify, uses backend API `/api/youtube-music/*` endpoints)
- **Local Files**: `LocalFileProvider` (allows users to select audio files from device storage)
  - Requires `SPOTIFY_CLIENT_ID` and `SPOTIFY_CLIENT_SECRET` environment variables
  - Connection verification: `_checkSpotifyConnection()` in `music_provider_settings_screen.dart`
  - Settings screen: `lib/screens/music_provider_settings_screen.dart` with pull-to-refresh
  - Error handling: Improved messages for authentication and connection issues
- **Apple Music**: `AppleMusicProvider` (iOS only, uses system APIs)
- **Fallback**: `FallbackAudioProvider` using `audioplayers` package with local assets
- Fallback audio assets: `assets/audio/` directory (created with `.gitkeep`)

### Song-Based Timer Flow
1. User starts timer with song-based habit
2. Service initializes music provider (checks for linked Spotify/Apple Music, falls back to local audio)
3. Listens for track changes via provider SDK or audio player completion events
4. On each track change, decrements `songsRemaining` and updates `currentSongTitle`
5. When `songsRemaining == 0`, triggers `onHabitComplete()` callback
6. Callback marks habit as complete and navigates to Mood Rating screen (CompletionFeedbackSheet)

### Widget Integration
- Android widget (`HabitProgressAppWidget.kt`): Displays song title and count in RemoteViews
- iOS widget (`HabitProgressWidget.swift`): Displays song title and count in WidgetKit view
- Snapshot service includes timer state: `lib/services/habit_progress_widget_snapshot_service.dart`

### Native Platform Code
- Android: `android/app/src/main/kotlin/com/digitalvisionboard/app/MusicProviderHandler.kt`
  - **Package name**: Migrated from `com.example.digital_vision_board` to `com.digitalvisionboard.app`
  - Uses MediaSession API to detect currently playing tracks
  - Supports polling fallback for devices without notification listener permission
  - MainActivity: `android/app/src/main/kotlin/com/digitalvisionboard/app/MainActivity.kt`
- iOS: `ios/Runner/MusicProviderHandler.swift`
- Method channel: `dvb/music_provider` for track detection
- Spotify OAuth: Handled via backend API, not native SDK

---

## 8) Completion semantics and feedback prompts (unified behavior)

### Habit completion
- Weekly scheduled habits can only be toggled on scheduled dates.
- When toggled ON and feedback is missing for today, prompt for feedback.

### Checklist item completion
- When a checklist item is checked ON:
  - If item feedback missing for today → prompt for feedback.
- If that check causes the task to become fully complete:
  - If task-level feedback missing for today → prompt for task-level feedback.
- Special case: if the task has exactly 1 checklist item, do NOT show two prompts back-to-back.
  - In that case, skip item-level feedback and only ask the task-level “Task completed” feedback.

Shared helpers:
- Completion application: `lib/services/habit_completion_applier.dart`
- Feedback UI: `lib/widgets/dialogs/completion_feedback_sheet.dart` (`showCompletionFeedbackSheet`)

Where completion+feedback is implemented (must stay consistent):
- `lib/widgets/habit_tracker_sheet.dart`
- `lib/screens/tasks_list_screen.dart`
- `lib/widgets/dashboard/all_boards_tasks_tab.dart`
- Habits equivalents:
  - `lib/screens/habits_list_screen.dart`
  - `lib/widgets/dashboard/all_boards_habits_tab.dart`

---

## 9) Add flows (goal picker + creation dialogs)

Goal picker (select goal to attach habit/task to):
- `lib/widgets/dialogs/goal_picker_sheet.dart`

Add/edit dialogs (shared, reused across screens):
- **Goals**: `lib/widgets/dialogs/add_goal_dialog.dart` - Unified dialog for adding/editing goals
  - Used in grid editor for consistent goal creation UI
  - Supports name, category, why important, and deadline fields
  - Provides consistent styling and theme-aware colors
- **Habits**: `lib/widgets/dialogs/add_habit_dialog.dart`
  - Compact layout is bounded below the status bar (prevents dialog covering notification bar).
- **Tasks / todos**: In-sheet add via `lib/widgets/todos/goal_todo_tab.dart` (inline text field + dialogs); full-screen lists use `lib/widgets/dialogs/text_input_dialog.dart` for simple title prompt (`showTextInputDialog`). Task/checklist structure is managed in `TaskItem`/`ChecklistItem`; add-habit flow uses `add_habit_dialog.dart`.

Global aggregation screens:
- Per-board lists:
  - `lib/screens/habits_list_screen.dart`
  - `lib/screens/tasks_list_screen.dart` (supports adding checklist items inside tasks)
- All-boards dashboard tabs:
  - `lib/widgets/dashboard/all_boards_habits_tab.dart` (Add habit = pick board → pick goal → dialog → save)
  - `lib/widgets/dashboard/all_boards_tasks_tab.dart` (Add task + Add checklist item; same pattern)

---

## 9.5) Wizard flow (create board with recommended goals)

The wizard helps users create boards with recommended goals:
- Entry: `lib/screens/wizard/create_board_wizard_screen.dart`
- Steps:
  1. Board setup: `lib/screens/wizard/wizard_step1_board_setup.dart`
  2. Goals for core values: `lib/screens/wizard/wizard_step_goals_for_core_value.dart`
  3. Grid preview: `lib/screens/wizard/wizard_step3_generate_grid_preview.dart`
  4. Customize grid: `lib/screens/wizard/wizard_step4_customize_grid.dart`

### Recommended Goals with Default Images
- When users add recommended goals in step 2, they can select from AI-generated recommendations via `WizardRecommendationsService`
- In step 4 (`wizard_step4_customize_grid.dart`), before building the board:
  - Default images are automatically fetched for all goals
  - Images are fetched by category using `CategoryImagesService.getCategoryImageUrls()` (preferred)
  - Falls back to `StockImagesService.searchPexelsUrls()` if category images aren't available
  - Images are assigned to goals and passed to `WizardBoardBuilderService.build()` via `defaultImageUrlsByGoalId` parameter
- `WizardBoardBuilderService` (`lib/services/wizard_board_builder.dart`):
  - Accepts optional `defaultImageUrlsByGoalId: Map<String, String>?` parameter
  - When creating grid tiles for goals, uses the provided default image URL if available
  - Default images are stored as URLs (not downloaded/persisted initially) for fast board creation
- Grid editor (`lib/screens/grid_board_editor.dart`):
  - Displays default images (URLs) using `NetworkImage` via `fileImageProviderFromPath()`
  - Users can still search Pexels to replace default images (see section D below)
  - Existing prefill logic (lines 125-159 in `wizard_step4_customize_grid.dart`) remains as a fallback for any tiles that still don't have images

### Image Services
- `CategoryImagesService` (`lib/services/category_images_service.dart`): Fetches curated images by core value + category from backend
- `StockImagesService` (`lib/services/stock_images_service.dart`): Searches Pexels API for images
- Both return image URLs that can be displayed directly or downloaded/persisted later

---

## 10) Viewer-specific behaviors and UX constraints

### GridGoalViewerScreen
- The entire screen is a `HabitTrackerSheet` bound to a single `GridTileModel`.
- Uses a `ValueKey(tile.id)` when switching tiles so the sheet remounts cleanly.

---

## 12) Stability / “gotchas” (important for AI edits)

### A) TextEditingController + dialogs
Avoid creating a controller outside a dialog and disposing it immediately after `await showDialog(...)`.
This can crash during route pop animations on some devices (“used after being disposed”).

Example fix:
- `lib/screens/tasks_list_screen.dart` add-task dialog returns a string without an external controller.

### B) Checklist uncheck bug
If you see “can’t uncheck checklist items”, check `ChecklistItem.copyWith` semantics:
- Clearing `completedOn` requires allowing `null` to be passed through (sentinel pattern).
- File: `lib/models/task_item.dart`

### C) Avoid duplicate symbol definitions
Keep shared dialogs/services single-defined. Some files previously contained duplicated class definitions; those were deduped.

### D) Web vs. file system (File type)
Code that runs on both web and mobile must not use `dart:io` File directly when compiled for web (web uses `dart:html`, and `File`/`exists()`/`FileImage` differ). Use `lib/utils/file_image_provider.dart`: `fileExists(path)` and `fileImageProviderFromPath(path)` so the same screen compiles on all platforms.

---

## 11) Quick entry points (if you’re new)

- App entry: `lib/main.dart`
- Home: `lib/screens/vision_board_home_screen.dart`
- Main dashboard: `lib/screens/dashboard_screen.dart`; body: `lib/widgets/dashboard/dashboard_body.dart`
- Tracker: `lib/widgets/habit_tracker_sheet.dart`
- Completion/feedback: `lib/services/habit_completion_applier.dart`, `lib/widgets/dialogs/completion_feedback_sheet.dart`
- File/image (web-safe): `lib/utils/file_image_provider.dart` (`fileExists`, `fileImageProviderFromPath`)
- Rhythmic Timer: `lib/services/rhythmic_timer_service.dart`, `lib/screens/rhythmic_timer_screen.dart`
- Wizard (create board with recommended goals): `lib/screens/wizard/create_board_wizard_screen.dart`, `lib/services/wizard_board_builder.dart`
- Image services: `lib/services/category_images_service.dart`, `lib/services/stock_images_service.dart`
- Puzzle Game: `lib/services/puzzle_service.dart`, `lib/screens/puzzle_game_screen.dart`, `lib/widgets/dashboard/puzzle_widget.dart`
- “All boards” tabs: `lib/widgets/dashboard/*`
- Goal canvas viewer/editor: `lib/screens/goal_canvas_*`
- Grid board editor + goal viewer: `lib/screens/grid_editor.dart` (exports `grid_board_editor.dart`), `lib/screens/grid_goal_viewer_screen.dart`
- Journal / Affirmations / Insights: `lib/screens/journal_notes_screen.dart`, `lib/screens/affirmation_screen.dart`, `lib/screens/global_insights_screen.dart`

---

## 13) Dashboard Visualization

The dashboard tab displays vision boards as visual preview cards instead of simple list items.

### VisionBoardPreviewCard
- **File**: `lib/widgets/dashboard/vision_board_preview_card.dart`
- Displays a minified preview of each vision board with:
  - **Grid boards**: Shows up to 9 image tiles in a compact 3x3 grid layout
  - **Other board types**: Shows first available image component, or placeholder with board icon/color
  - Reduced opacity (0.65) for the preview content
  - Board name overlay at bottom with gradient background for readability
  - Edit and delete action buttons in the overlay
  - Active board indicator (highlighted border)

### Preview Rendering
- Uses `FutureBuilder` to asynchronously load board data:
  - Grid boards: `GridTilesStorageService.loadTiles()` to get tiles
  - Other boards: `VisionBoardComponentsStorageService.loadComponents()` to get first image component
- Images are rendered using `fileImageProviderFromPath()` (handles both URLs and local paths)
- Uses `StaggeredGrid.count` with `crossAxisCount: 3` for compact grid display
- Empty tiles show subtle placeholder icons
- Loading state shows circular progress indicator

### Dashboard Tab
- **File**: `lib/widgets/dashboard/dashboard_tab.dart`
- Uses `VisionBoardPreviewCard` in `ListView.builder` instead of `Card` + `ListTile`
- Maintains all existing callbacks (`onOpenEditor`, `onOpenViewer`, `onDeleteBoard`)
- Preserves empty state handling and "New" button
- Includes `PuzzleWidget` at the top of the list for puzzle game access

---

## 15) Puzzle Widget and Game Feature

The app includes a puzzle game feature that turns goal images into interactive 4x4 puzzles (16 pieces).

### Puzzle Service
- **File**: `lib/services/puzzle_service.dart`
- Manages puzzle state and image selection
- Handles automatic 4-hour rotation of puzzle images
- Provides methods to:
  - Get current puzzle image (auto-rotates if 4 hours have passed)
  - Get all available goal images from all boards
  - Manually set puzzle image
  - Get time until next automatic rotation
- Storage: Uses SharedPreferences to persist current image path and last rotation timestamp

### Puzzle Widget
- **File**: `lib/widgets/dashboard/puzzle_widget.dart`
- Displays on dashboard tab as a card widget
- Shows shuffled 4x4 puzzle preview (16 pieces in shuffled state)
- Features:
  - Settings button to manually select puzzle image
  - Tappable to navigate to full puzzle game screen
  - Handles loading and error states
  - Shows "No images available" message when appropriate

### Puzzle Game Screen
- **File**: `lib/screens/puzzle_game_screen.dart`
- Full-screen puzzle solving interface
- Features:
  - Drag-and-drop puzzle pieces (Flutter's `Draggable` and `DragTarget`)
  - 4x4 grid layout (16 pieces)
  - Completion detection with celebration dialog showing solve time
  - Reference image toggle (show/hide original image as overlay)
  - Shuffle button to reshuffle pieces
  - Image selection button to change puzzle image
  - Visual feedback for correct piece placement (highlighted borders)
  - **Animation fix**: Completion tile animation uses clamped opacity values (0.0-1.0) to prevent assertion errors with `Curves.easeOutBack` overshoot

### Puzzle Image Splitter
- **File**: `lib/utils/puzzle_image_splitter.dart`
- Utility to split images into puzzle pieces
- Uses `image` package (`package:image/image.dart`) for image manipulation
- Supports both local file paths and network URLs
- Splits image into 4x4 grid (16 equal pieces)
- Provides shuffle functionality for piece indices

### Puzzle Image Selector
- **File**: `lib/widgets/dialogs/puzzle_image_selector_sheet.dart`
- Bottom sheet dialog for manually selecting puzzle image
- Shows all available goal images from all boards in a grid
- Displays current puzzle image with checkmark indicator
- Images are loaded from:
  - Grid boards: `GridTilesStorageService` (image tiles)
  - Other boards: `VisionBoardComponentsStorageService` (ImageComponent instances)

### Integration Points
- **Dashboard Tab**: `lib/widgets/dashboard/dashboard_tab.dart`
  - `PuzzleWidget` is displayed at the top of the board list
- **Dashboard Drawer**: `lib/screens/dashboard_screen.dart`
  - "Puzzle Game" menu item added to drawer (after Settings)
  - Opens puzzle game with current puzzle image
  - Shows snackbar if no images are available

### Data Flow
1. Puzzle widget loads current image from `PuzzleService`
2. Service checks if 4 hours have passed since last rotation
3. If yes, automatically selects random image from available goal images
4. Image is split into 16 pieces using `PuzzleImageSplitter`
5. Pieces are shuffled and displayed in widget
6. Tapping widget navigates to `PuzzleGameScreen`
7. User can drag and drop pieces to solve puzzle
8. Completion is detected when all pieces are in correct positions

### Key Implementation Details
- Puzzle pieces are stored as `Uint8List` (PNG-encoded image bytes)
- Uses Flutter's built-in drag-and-drop APIs (`Draggable`, `DragTarget`)
- Puzzle state (piece positions) is managed in widget state
- Completion detection checks if `piecePositions[i] == i` for all pieces
- Timer tracks solve time from puzzle start to completion
- Images are loaded using `fileImageProviderFromPath()` utility (handles URLs and local paths)

---

## 14) User journeys (end-to-end flows with code entry points)

These are the most common “click paths” and what files implement them.

### A) Create a new board from the dashboard
- Start: `lib/screens/dashboard_screen.dart`
- Create/import: `lib/widgets/dialogs/new_board_dialog.dart`
- Storage for board list/metadata: `lib/services/boards_storage_service.dart`

### B) Goal canvas: open a goal and track habits/tasks
- Viewer screen: `lib/screens/goal_canvas_viewer_screen.dart`
- Tap a goal layer → opens tracker:
  - `GoalCanvasViewerScreen._openHabitTracker` → `HabitTrackerSheet`
- Persist updates:
  - `GoalCanvasViewerScreen._saveComponents` → `VisionBoardComponentsStorageService`

### C) Grid board: open a tile-goal and track
- Grid editor: `lib/screens/grid_board_editor.dart`
  - Supports adding images via: local picker, Pexels search (`showPexelsSearchSheet`), or text
  - Images can be URLs (from default images or Pexels) or local file paths (after download/persist)
  - `fileImageProviderFromPath()` handles both URLs (returns `NetworkImage`) and local paths (returns `FileImage`)
- Tile-goal viewer: `lib/screens/grid_goal_viewer_screen.dart`
  - Converts `GridTileModel` → `ImageComponent` for `HabitTrackerSheet`
  - Persists updates back into the tile via `GridTilesStorageService`

### I) Wizard: create board with recommended goals
- Start: `lib/screens/wizard/create_board_wizard_screen.dart`
- Step 2: Add goals (`wizard_step_goals_for_core_value.dart`)
  - Users can add recommended goals from `WizardRecommendationsService`
  - Recommended goals come with pre-filled habits and metadata
- Step 4: Customize grid (`wizard_step4_customize_grid.dart`)
  - Fetches default images for all goals before building the board
  - Opens grid editor with default images already populated
  - Users can replace default images via Pexels search in the grid editor

### J) Puzzle Game: solve puzzles from goal images
- Dashboard widget: `lib/widgets/dashboard/puzzle_widget.dart` (shows shuffled puzzle preview)
- Game screen: `lib/screens/puzzle_game_screen.dart` (full puzzle solving interface)
- Service: `lib/services/puzzle_service.dart` (manages image selection and 4-hour rotation)
- Image splitter: `lib/utils/puzzle_image_splitter.dart` (splits images into 4x4 pieces)
- Access points:
  - Dashboard tab: Tap puzzle widget to open game
  - Drawer menu: "Puzzle Game" menu item
- Image selection: `lib/widgets/dialogs/puzzle_image_selector_sheet.dart` (manual image picker)
- Puzzle automatically rotates to new random image every 4 hours
- Users can manually select which goal image to use for puzzle

### E) Add a habit/task from global lists (single-board)
- All habits: `lib/screens/habits_list_screen.dart`
  - Flow: goal picker (`goal_picker_sheet.dart`) → `add_habit_dialog.dart` → persist via callback
- All tasks: `lib/screens/tasks_list_screen.dart`
  - Add task: goal picker → simple title prompt → persist via callback
  - Add checklist item inside a task: inline “Add checklist item”

### F) Add a habit/task from “All boards” dashboard tabs
- All boards habits tab: `lib/widgets/dashboard/all_boards_habits_tab.dart`
  - Flow: pick board → goal picker → `add_habit_dialog.dart` → `onSaveBoardComponents(boardId, updated)`
- All boards tasks tab: `lib/widgets/dashboard/all_boards_tasks_tab.dart`
  - Flow: pick board → goal picker → add task/todo (text input or in-sheet via `GoalTodoTab`) → `onSaveBoardComponents(boardId, updated)`
  - Add checklist item / todo inside a task: inline in tracker or list screens (`goal_todo_tab.dart`, `text_input_dialog.dart`)

### G) Completion + feedback prompts (shared semantics)
- Completion application: `lib/services/habit_completion_applier.dart`
- Feedback UI: `lib/widgets/dialogs/completion_feedback_sheet.dart` (`showCompletionFeedbackSheet`)
- Implemented consistently across:
  - `lib/widgets/habit_tracker_sheet.dart`
  - `lib/screens/tasks_list_screen.dart`
  - `lib/widgets/dashboard/all_boards_tasks_tab.dart`
  - (habits) `lib/screens/habits_list_screen.dart`, `lib/widgets/dashboard/all_boards_habits_tab.dart`
  - Home widgets: `lib/screens/vision_board_home_widgets.dart`

### H) Rhythmic Timer: song-based habit completion
- Timer screen: `lib/screens/rhythmic_timer_screen.dart` (supports both time and song modes)
- Service: `lib/services/rhythmic_timer_service.dart`
- When songsRemaining reaches 0, triggers habit completion → mood rating screen
- Integrated in: `lib/widgets/habits/habit_tracker_tracker_tab.dart` (timer button opens appropriate screen)
- Spotify selection: `lib/screens/spotify_selection_screen.dart` for choosing playlists/tracks
- Music provider settings: `lib/screens/music_provider_settings_screen.dart` for OAuth connection

---

## 16) Typography and Theme System

### Typography System
The app uses a standardized typography system defined in `lib/utils/app_typography.dart`:
- `AppTypography.heading1(context)` - 24sp, bold - Main screen titles
- `AppTypography.heading2(context)` - 20sp, semi-bold - Section titles
- `AppTypography.heading3(context)` - 18sp, semi-bold - Subsection titles and card titles
- `AppTypography.body(context)` - 16sp, regular - Main content text
- `AppTypography.bodySmall(context)` - 14sp, regular - Secondary content
- `AppTypography.caption(context)` - 12sp, regular - Captions, hints, metadata
- `AppTypography.button(context)` - 16sp, medium - Button text
- `AppTypography.secondary(context)` - 14sp, regular - Less prominent text (uses onSurfaceVariant)
- `AppTypography.error(context)` - 14sp, regular - Error text (uses error color)

All typography styles use theme-aware colors that adapt to light/dark mode.

### Theme Colors Guidelines
The app uses Material 3 theming with proper light/dark mode support:
- **Never use hardcoded colors** like `Colors.black54`, `Colors.grey`, `Colors.white`, etc.
- **Always use theme colors** from `Theme.of(context).colorScheme`:
  - `colorScheme.onSurface` - Primary text color
  - `colorScheme.onSurfaceVariant` - Secondary text color (replaces `Colors.grey`, `Colors.black54`)
  - `colorScheme.outline.withOpacity(0.12)` - Borders and dividers (replaces `Colors.black12`)
  - `colorScheme.error` - Error states (replaces `Colors.red`)
  - `colorScheme.primary` - Primary actions and highlights
  - `colorScheme.surface` - Background surfaces
  - `colorScheme.tertiary` / `colorScheme.tertiaryContainer` - Accent colors (replaces `Colors.orange`, `Colors.green.shade200`)

### Text Alignment
- Use consistent text alignment across screens
- Dialog titles and content should be left-aligned by default
- Center alignment should be used sparingly (e.g., empty states, centered buttons)
- Form fields should be left-aligned with proper labels

### Theme Configuration
Theme is configured in `lib/main.dart` with:
- Light theme: `ColorScheme.fromSeed(seedColor: Colors.deepPurple, brightness: Brightness.light)`
- Dark theme: `ColorScheme.fromSeed(seedColor: Colors.deepPurple, brightness: Brightness.dark)`
- Text theme with standardized font sizes and weights
- Material 3 enabled for modern UI components

---

## 18) Build Configuration and Environment Variables

### Build Configuration
- **Icon Tree-Shaking**: Build uses `--no-tree-shake-icons` flag to support dynamic IconData instances
  - Helper function: `IconService.iconFromCodePoint()` in `lib/services/icon_service.dart`
  - Used in: `routine_editor_screen.dart`, `routine_timer_screen.dart`, `routine_preview_card.dart`
  - Reason: Routines/todos store icon code points dynamically, so Flutter can't tree-shake at compile time

### Environment Variables
Backend requires these environment variables (see `ENV_SETUP.md` for full list):
- **Core**: `PORT`, `BASE_URL`
- **Spotify OAuth** (required for Spotify integration):
  - `SPOTIFY_CLIENT_ID` - Spotify app client ID from [Spotify Developer Dashboard](https://developer.spotify.com/dashboard)
  - `SPOTIFY_CLIENT_SECRET` - Spotify app client secret
  - `SPOTIFY_REDIRECT_URI` - OAuth callback URL (defaults to `${BASE_URL}/auth/spotify/callback`)
  - `SPOTIFY_SCOPES` - OAuth scopes (default: `user-read-private user-read-email playlist-read-private playlist-read-collaborative user-library-read`)
- **Database**: `DATABASE_URL` (optional, uses JSON file storage if not set)
- **Other**: `GEMINI_API_KEY`, `PEXELS_API_KEY`, `FIREBASE_SERVICE_ACCOUNT_JSON` (all optional)

### Spotify Integration Flow
1. User navigates to Settings → Music Provider Settings
2. Taps "Connect" button for Spotify
3. Backend generates OAuth URL with PKCE challenge
4. User completes OAuth in browser
5. Backend stores tokens in database (`dv_users.spotify_*` columns)
6. Settings screen verifies connection via test API call
7. User can now access playlists and search tracks

### Error Handling
- **Authentication errors**: Clear messages prompting user to log in or connect Spotify
- **Connection errors**: Settings screen shows connection status and "Connect" button when needed
- **API errors**: Proper error messages distinguish between "not logged in" vs "Spotify not connected"

### Privacy Policy
- **Backend route**: `GET /privacy-policy` - Serves a standalone HTML privacy policy page
- **Purpose**: Required by Google Play Console for apps using sensitive permissions (CAMERA, LOCATION, etc.)
- **Content**: Explains data collection, storage, permissions, and user rights
- **Canva App Panel**: Links to `/privacy-policy` route instead of anchor link for separate URL
- **Location**: `backend/src/server.js` - Privacy policy route serves HTML with styling

---

## 19) Backend API and app integration

The Flutter app talks to a Node/Express backend. Base URL and auth are provided by `DvAuthService`; all authenticated requests use `Authorization: Bearer <dvToken>`.

### Backend overview
- **Entry**: `backend/src/server.js` (Express app). Vercel serverless: `backend/api/index.js` exports the same app.
- **Auth middleware**: `backend/src/auth.js` — `requireDvAuth()` (validates Bearer token, sets `req.dvUser`), `requireAdmin()` (requires dvAuth + admin user id in `DV_ADMIN_USER_IDS`).
- **Base URL (app)**: `DvAuthService.backendBaseUrl()` — from `BACKEND_BASE_URL` (compile-time, default `https://digital-vision-board.onrender.com`).

### Auth and token
- **dvToken**: Backend-issued token stored in SharedPreferences (`dv_auth_token_v1`). Used as `Authorization: Bearer <dvToken>` on protected routes.
- **Guest tokens**: Expire in 10 days; backend returns `expired_auth` when expired; app shows auth gateway on 401.
- **Obtaining a token**: Guest (`POST /auth/guest`), Firebase exchange (`POST /auth/firebase/exchange`), or Canva OAuth (poll flow). Music OAuth (Spotify/YouTube Music) does not issue dvToken; it links the current user to a music provider.

### API endpoints (current) and app usage

| Method | Path | Auth | Purpose | App integration |
|--------|------|------|---------|-----------------|
| GET | `/` | — | Info text | — |
| GET | `/health` | — | Health check | — |
| GET | `/privacy-policy` | — | HTML privacy page | Canva panel / external link |
| GET | `/stock/pexels/search` | — | Pexels search proxy (query, perPage) | `StockImagesService.searchPexelsUrls()` — grid Pexels search |
| GET | `/stock/category-images` | — | Category images by coreValueId + category (DB cache) | `CategoryImagesService.getCategoryImages()` — wizard default images |
| GET | `/wizard/defaults` | — | Core values + categories | `WizardDefaultsService` — wizard step 1 defaults (cached) |
| GET | `/wizard/recommendations` | — | Goals for coreValueId + category + gender | `WizardRecommendationsService.get()` — wizard step 2 recommendations |
| POST | `/wizard/recommendations/generate` | — | Generate recommendations (Gemini) | `WizardRecommendationsService.generate()` / `getOrGenerate()` |
| POST | `/auth/guest` | — | Create guest session (body: home_timezone, gender) | `DvAuthService.continueAsGuest()` |
| POST | `/auth/firebase/exchange` | — | Exchange Firebase idToken for dvToken | `DvAuthService.exchangeFirebaseIdTokenForDvToken()` |
| GET | `/auth/canva/start_poll` | — | Canva OAuth start (returns authUrl, pollToken) | `DvAuthService.connectViaCanvaOAuth()` (poll) |
| GET | `/auth/canva/poll` | — | Poll for Canva OAuth result (query: pollToken) | Same |
| GET | `/canva/connect` | — | Alias for Canva OAuth start | — |
| GET | `/auth/canva/start` | — | Canva OAuth start (redirect flow) | — |
| GET | `/auth/canva/callback` | — | Canva OAuth callback | — |
| GET | `/auth/spotify/start` | — | Spotify OAuth start (redirect) | User opens in browser; `MusicProviderSettingsScreen` launches URL |
| GET | `/auth/spotify/callback` | — | Spotify OAuth callback | — |
| GET | `/api/spotify/playlists` | dvAuth | List user playlists | `MusicProviderService` (Spotify), connection check in settings |
| GET | `/api/spotify/search` | dvAuth | Search Spotify (q, type) | `MusicProviderService` |
| GET | `/api/spotify/playlist/:playlistId/tracks` | dvAuth | Playlist tracks | `MusicProviderService` |
| GET | `/auth/youtube-music/start` | — | YouTube Music OAuth start | Same pattern as Spotify |
| GET | `/auth/youtube-music/callback` | — | YouTube Music callback | — |
| GET | `/api/youtube-music/playlists` | dvAuth | List playlists | `MusicProviderService` (YouTube Music) |
| GET | `/api/youtube-music/search` | dvAuth | Search | `MusicProviderService` |
| GET | `/api/youtube-music/playlist/:playlistId/tracks` | dvAuth | Playlist tracks | `MusicProviderService` |
| GET | `/habits` | dvAuth | Legacy habits list | — |
| GET | `/templates` | dvAuth | List templates | `TemplatesService.listTemplates()` |
| GET | `/templates/:id` | dvAuth | Get template by id | `TemplatesService.getTemplate()` |
| GET | `/template-images/:id` | — | Template image (public) | `TemplatesService` image URL helper |
| GET | `/sync/bootstrap` | dvAuth | Bootstrap empty app (boards, settings) | `SyncService.bootstrapIfNeeded()` |
| POST | `/sync/push` | dvAuth | Push outbox (boards, habitCompletions, userSettings) | `SyncService.flush()` |
| PUT | `/user/settings` | dvAuth | Update home_timezone, gender | `DvAuthService.putUserSettings()` |
| GET | `/api/affirmations` | dvAuth | List affirmations (query: limit, offset) | `AffirmationService.loadAffirmations()` |
| POST | `/api/affirmations` | dvAuth | Create affirmation | `AffirmationService.createAffirmation()` |
| PUT | `/api/affirmations/:id` | dvAuth | Update affirmation | `AffirmationService.updateAffirmation()` |
| DELETE | `/api/affirmations/:id` | dvAuth | Delete affirmation | `AffirmationService.deleteAffirmation()` |
| PUT | `/api/affirmations/:id/pin` | dvAuth | Pin/unpin affirmation | `AffirmationService.togglePin()` |
| GET | `/admin/templates` | admin | List templates (admin) | `TemplatesService.listTemplatesAdmin()` |
| POST | `/admin/template-images` | admin | Upload template image (multipart) | `TemplatesService.uploadTemplateImage()` |
| POST | `/admin/templates` | admin | Create template | `TemplatesService.createTemplate()` |
| PUT | `/admin/templates/:id` | admin | Update template | `TemplatesService.updateTemplate()` |
| DELETE | `/admin/templates/:id` | admin | Delete template | `TemplatesService.deleteTemplate()` |
| POST | `/admin/wizard/sync-defaults` | admin | Sync wizard defaults (blocking) | `TemplatesService.syncWizardDefaults()` (legacy) |
| POST | `/admin/wizard/sync-defaults/start` | admin | Start sync job | Admin / dev |
| GET | `/admin/wizard/sync-defaults/status` | admin | Sync job status | `TemplatesService` poll |
| POST | `/admin/stock/sync-category-images/start` | admin | Start category images sync | Admin / dev |
| GET | `/admin/stock/sync-category-images/status` | admin | Sync job status | `TemplatesService` poll |
| POST | `/admin/canva/import/current-page` | admin | Canva import (admin) | `TemplatesService.importCanvaCurrentPage()` |
| GET | `/canva/packages` | dvAuth | Canva packages | Canva integration |
| GET | `/canva/packages/latest` | dvAuth | Latest package | Canva integration |
| GET | `/canva/packages/:id` | dvAuth | Package by id | Canva integration |
| POST | `/habits` | dvAuth | Legacy habits | — |
| POST | `/canva/sync` | dvAuth | Canva sync | Canva integration |
| POST | `/canva/export` | dvAuth | Canva export | Canva integration |

### App-side API usage summary
- **Auth**: `lib/services/dv_auth_service.dart` — guest, Firebase exchange, Canva OAuth; stores dvToken; `putUserSettings()` → `PUT /user/settings`.
- **Sync**: `lib/services/sync_service.dart` — `GET /sync/bootstrap`, `POST /sync/push`; 401 sets `SyncService.authExpired`.
- **Wizard**: `WizardDefaultsService` → `GET /wizard/defaults`; `WizardRecommendationsService` → `GET /wizard/recommendations`, `POST /wizard/recommendations/generate`.
- **Stock images**: `StockImagesService` → `GET /stock/pexels/search`; `CategoryImagesService` → `GET /stock/category-images` (no auth).
- **Templates**: `TemplatesService` → `/templates`, `/templates/:id`, `/template-images/:id`; admin: `/admin/templates`, `/admin/template-images`, sync-defaults and sync-category-images start/status.
- **Music**: `MusicProviderService` + `MusicProviderSettingsScreen` — Spotify/YouTube Music OAuth via `/auth/spotify/start`, `/auth/youtube-music/start`; API calls to `/api/spotify/*`, `/api/youtube-music/*` with Bearer token.
- **Affirmations**: `AffirmationService` — CRUD and pin via `/api/affirmations*` with Bearer token.

### Flow notes
- **Guest**: App calls `POST /auth/guest` (optional body: home_timezone, gender), stores dvToken and expiresAt; subsequent requests use Bearer token until expiry; then app shows auth gateway.
- **Sync**: On empty local boards, app calls `GET /sync/bootstrap` to seed boards/settings; after local changes, `SyncService` enqueues and calls `POST /sync/push` (best-effort, skipped on web when backend unreachable).
- **Wizard**: Defaults and recommendations are public (no auth); category images and Pexels are also public; wizard steps use these to build the board locally.
- **Music OAuth**: User taps Connect in settings; app opens `/auth/spotify/start` or `/auth/youtube-music/start` in browser; backend redirects to provider and stores tokens per user (by dvToken in session/callback); app then uses `/api/spotify/*` or `/api/youtube-music/*` with the same dvToken.

---

## 17) Glossary (UI term → code type)

- Board:
  - `VisionBoardInfo` (`lib/models/vision_board_info.dart`) + persisted via `BoardsStorageService`
- Goal (general concept: something you attach habits/tasks to):
  - Goal canvas: usually an `ImageComponent` with `goal` metadata
  - Grid: `GridTileModel` (converted to `ImageComponent` for tracker UI)
- Layer:
  - A `VisionComponent` entry in the board’s components list (ordered by `zIndex`)
  - Managed via `showLayersSheet` in `lib/widgets/editor/layers_sheet.dart`
- Habit:
  - `HabitItem` (`lib/models/habit_item.dart`) stored on a goal’s component/tile
- Task:
  - `TaskItem` (`lib/models/task_item.dart`) stored on a goal’s component/tile
- Checklist item:
  - `ChecklistItem` (`lib/models/task_item.dart`)
  - Completion stored in `completedOn` (YYYY-MM-DD) and per-day feedback in `feedbackByDate`
- “Tracker”:
  - The per-goal tracking UI: `HabitTrackerSheet` (`lib/widgets/habit_tracker_sheet.dart`)
