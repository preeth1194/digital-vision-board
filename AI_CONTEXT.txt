AI_CONTEXT — Digital Vision Board (Flutter)
Last updated: 2026-01-17

This document is optimized for AI + human onboarding. It explains what the app does, where data lives, and how the main workflows are implemented in code.

---

## 1) What the app does (product mental model)

Digital Vision Board lets users create “boards” and attach “goals” to them. Each goal can have:
- Habits (daily/weekly scheduled completion tracking)
- Tasks (each task has a checklist; checklist items can be completed per-day and can store completion feedback)

Daily loop:
- Open a board
- Open a goal
- Check off habits/tasks (optionally leave a rating + note)
- Review progress/insights

---

## 2) Board types (UIs) and how they map to storage

There are multiple board “canvas” experiences. They differ in how goals are represented and how they are stored.

### A) Freeform “Vision Board” (Canva-like editor)
- Editor: `lib/screens/vision_board_editor_screen.dart`
- Model storage: `VisionBoardComponentsStorageService` (components keyed by boardId)

### B) Goal Canvas (freeform layers over optional background)
- Viewer: `lib/screens/goal_canvas_viewer_screen.dart`
- Editor: `lib/screens/goal_canvas_editor_screen.dart`
- Storage: `lib/services/vision_board_components_storage_service.dart`
- Supports “Layers” UI via `showLayersSheet` (see section 6)

### C) Physical Board (photo background + goal overlays)
- Viewer: `lib/screens/physical_board_viewer_screen.dart`
- Editor: `lib/screens/physical_board_editor_screen.dart`
- Storage:
  - Components: `lib/services/vision_board_components_storage_service.dart`
  - Background image path: `BoardsStorageService.boardImagePathKey(boardId)`
- Goals are `GoalOverlayComponent` anchored in image pixel space (`lib/models/goal_overlay_component.dart`).

### D) Grid Board (structured tile layout)
- Editor: `lib/screens/grid_board_editor.dart`
- Storage: `lib/services/grid_tiles_storage_service.dart` (tiles keyed by boardId)
- Single “goal” viewer: `lib/screens/grid_goal_viewer_screen.dart`

---

## 3) Core data model (what “goal”, “habit”, “task” mean in code)

### VisionComponent (core “node”)
`VisionComponent` is the base type for nodes on freeform canvases.
- Location/size/z-index exist for visuals.
- It also owns the tracker data:
  - `habits: List<HabitItem>`
  - `tasks: List<TaskItem>`

Key files:
- `lib/models/vision_component.dart` (base)
- `lib/models/vision_component_factory.dart` (JSON deserialization)
- `lib/models/vision_components.dart` (exports concrete components)
- `lib/models/image_component.dart` (image goal layer; often has `goal` metadata)
- `lib/models/goal_overlay_component.dart` (physical board goal overlay)

### GridTileModel
Grid boards don’t store `VisionComponent`s directly. They store tiles:
- `lib/models/grid_tile_model.dart`
- Each tile can have: `goal`, `habits`, `tasks`

For tracking UI, `GridGoalViewerScreen` converts a tile into an `ImageComponent` (see section 5).

### HabitItem
`lib/models/habit_item.dart`
- Tracks completion dates / streaks
- Supports weekly schedule gating (`isScheduledOnDate`)
- Stores per-day completion feedback (see below)

### TaskItem + ChecklistItem
`lib/models/task_item.dart`
- `TaskItem` owns:
  - `checklist: List<ChecklistItem>`
  - optional task-level completion feedback by date (`completionFeedbackByDate`)
- `ChecklistItem` owns:
  - `completedOn` (YYYY-MM-DD) when checked
  - `feedbackByDate` (per-day checklist-item completion feedback)
  - optional `dueDate` and optional CBT enhancements

Important bug fix: `ChecklistItem.copyWith` uses a sentinel so callers can explicitly clear nullable fields like `completedOn` (unchecking).

---

## 4) Persistence (where data is saved)

### Boards list + board metadata
- `lib/services/boards_storage_service.dart`

### Components (freeform boards: vision board / goal canvas / physical board)
- `lib/services/vision_board_components_storage_service.dart`
- Components are JSON encoded and stored keyed by `boardId`.

### Grid tiles
- `lib/services/grid_tiles_storage_service.dart`
- Tiles are JSON encoded and stored keyed by `boardId`.

---

## 5) The tracker UI: HabitTrackerSheet

Main tracker UI:
- `lib/widgets/habit_tracker_sheet.dart`

Usage patterns:
- Shown as a bottom sheet from viewers (Goal canvas / Physical board viewers).
- Embedded full-screen in `GridGoalViewerScreen` as the whole page body.

Tabs:
- Tracker (habits list)
- Tasks (tasks list + checklist)
- Insights (activity/streak summaries)

It emits updated `VisionComponent` back to the caller via `onComponentUpdated`, and callers persist the updated component list/tile.

---

## 6) Layers UI (showLayersSheet)

Shared “Layers” bottom sheet:
- `lib/widgets/editor/layers_sheet.dart` → `showLayersSheet(...)`

Where it’s used:
- Goal canvas viewer: `GoalCanvasViewerScreen._showLayers` (AppBar button on Canvas tab)
- Physical board viewer: `PhysicalBoardViewerScreen._showLayers` (AppBar button on Photo tab)
  - also supports toggling `isDisabled` (mark completed)
- Grid goal viewer: `GridGoalViewerScreen._showLayers` (top-right overlay button)
  - used to jump between tile-goals without backing out

Selection behavior:
- Selecting a layer updates the viewer’s selected id (highlights it visually).

---

## 7) Completion semantics + feedback prompts (unified behavior)

### Habit completion
- Weekly scheduled habits can only be toggled on scheduled dates.
- When toggled ON and feedback is missing for today, prompt for feedback.

### Checklist item completion
- When a checklist item is checked ON:
  - If item feedback missing for today → prompt for feedback.
- If that check causes the task to become fully complete:
  - If task-level feedback missing for today → prompt for task-level feedback.
- Special case: if the task has exactly 1 checklist item, do NOT show two prompts back-to-back.
  - In that case, skip item-level feedback and only ask the task-level “Task completed” feedback.

Shared helpers:
- Mutation / state derivation: `lib/services/completion_mutations.dart`
- Feedback UI: `lib/widgets/dialogs/completion_feedback_sheet.dart` (`showCompletionFeedbackSheet`)

Where completion+feedback is implemented (must stay consistent):
- `lib/widgets/habit_tracker_sheet.dart`
- `lib/screens/tasks_list_screen.dart`
- `lib/widgets/dashboard/all_boards_tasks_tab.dart`
- Habits equivalents:
  - `lib/screens/habits_list_screen.dart`
  - `lib/widgets/dashboard/all_boards_habits_tab.dart`

---

## 8) Add flows (goal picker + creation dialogs)

Goal picker (select goal to attach habit/task to):
- `lib/widgets/dialogs/goal_picker_sheet.dart`

Add/edit dialogs (shared, reused across screens):
- Habits: `lib/widgets/dialogs/add_habit_dialog.dart`
  - Compact layout is bounded below the status bar (prevents dialog covering notification bar).
- Tasks (full dialog with optional CBT fields): `lib/widgets/dialogs/add_task_dialog.dart`
- Checklist items (due date + optional CBT): `lib/widgets/dialogs/add_checklist_item_dialog.dart`

Global aggregation screens:
- Per-board lists:
  - `lib/screens/habits_list_screen.dart`
  - `lib/screens/tasks_list_screen.dart` (supports adding checklist items inside tasks)
- All-boards dashboard tabs:
  - `lib/widgets/dashboard/all_boards_habits_tab.dart` (Add habit = pick board → pick goal → dialog → save)
  - `lib/widgets/dashboard/all_boards_tasks_tab.dart` (Add task + Add checklist item; same pattern)

---

## 9) Viewer-specific behaviors and UX constraints

### PhysicalBoardViewerScreen
- Tapping an overlay opens `HabitTrackerSheet` as a bottom sheet.
- The bottom sheet is constrained so it does not cover the AppBar (max height excludes status+toolbar).

### GridGoalViewerScreen
- The entire screen is a `HabitTrackerSheet` bound to a single `GridTileModel`.
- Uses a `ValueKey(tile.id)` when switching tiles so the sheet remounts cleanly.

---

## 10) Stability / “gotchas” (important for AI edits)

### A) TextEditingController + dialogs
Avoid creating a controller outside a dialog and disposing it immediately after `await showDialog(...)`.
This can crash during route pop animations on some devices (“used after being disposed”).

Example fix:
- `lib/screens/tasks_list_screen.dart` add-task dialog returns a string without an external controller.

### B) Checklist uncheck bug
If you see “can’t uncheck checklist items”, check `ChecklistItem.copyWith` semantics:
- Clearing `completedOn` requires allowing `null` to be passed through (sentinel pattern).
- File: `lib/models/task_item.dart`

### C) Avoid duplicate symbol definitions
Keep shared dialogs/services single-defined. Some files previously contained duplicated class definitions; those were deduped.

---

## 11) Quick entry points (if you’re new)

- App entry: `lib/main.dart`
- Main dashboard: `lib/screens/dashboard_screen.dart`
- Tracker: `lib/widgets/habit_tracker_sheet.dart`
- Completion/feedback: `lib/services/completion_mutations.dart`, `lib/widgets/dialogs/completion_feedback_sheet.dart`
- “All boards” tabs: `lib/widgets/dashboard/*`
- Physical board viewer/editor: `lib/screens/physical_board_*`
- Goal canvas viewer/editor: `lib/screens/goal_canvas_*`
- Grid board editor + goal viewer: `lib/screens/grid_board_editor.dart`, `lib/screens/grid_goal_viewer_screen.dart`

---

## 12) User journeys (end-to-end flows with code entry points)

These are the most common “click paths” and what files implement them.

### A) Create a new board from the dashboard
- Start: `lib/screens/dashboard_screen.dart`
- Create/import: `lib/widgets/dialogs/new_board_dialog.dart`
- Storage for board list/metadata: `lib/services/boards_storage_service.dart`

### B) Goal canvas: open a goal and track habits/tasks
- Viewer screen: `lib/screens/goal_canvas_viewer_screen.dart`
- Tap a goal layer → opens tracker:
  - `GoalCanvasViewerScreen._openHabitTracker` → `HabitTrackerSheet`
- Persist updates:
  - `GoalCanvasViewerScreen._saveComponents` → `VisionBoardComponentsStorageService`

### C) Physical board: scan/import photo → create overlays → track
- Editor: `lib/screens/physical_board_editor_screen.dart`
  - Imports photo via `lib/services/board_scan_service.dart`
  - Creates overlay goals: `GoalOverlayComponent` (`lib/models/goal_overlay_component.dart`)
  - Persists components: `VisionBoardComponentsStorageService`
- Viewer: `lib/screens/physical_board_viewer_screen.dart`
  - Tap overlay → `_openHabitTracker` (bottom sheet) → `HabitTrackerSheet`
  - Bottom sheet height is constrained so it does not cover the AppBar.

### D) Grid board: open a tile-goal and track
- Grid editor: `lib/screens/grid_board_editor.dart`
- Tile-goal viewer: `lib/screens/grid_goal_viewer_screen.dart`
  - Converts `GridTileModel` → `ImageComponent` for `HabitTrackerSheet`
  - Persists updates back into the tile via `GridTilesStorageService`

### E) Add a habit/task from global lists (single-board)
- All habits: `lib/screens/habits_list_screen.dart`
  - Flow: goal picker (`goal_picker_sheet.dart`) → `add_habit_dialog.dart` → persist via callback
- All tasks: `lib/screens/tasks_list_screen.dart`
  - Add task: goal picker → simple title prompt → persist via callback
  - Add checklist item inside a task: inline “Add checklist item”

### F) Add a habit/task from “All boards” dashboard tabs
- All boards habits tab: `lib/widgets/dashboard/all_boards_habits_tab.dart`
  - Flow: pick board → goal picker → `add_habit_dialog.dart` → `onSaveBoardComponents(boardId, updated)`
- All boards tasks tab: `lib/widgets/dashboard/all_boards_tasks_tab.dart`
  - Flow: pick board → goal picker → `add_task_dialog.dart` → `onSaveBoardComponents(boardId, updated)`
  - Add checklist item inside a task: `add_checklist_item_dialog.dart`

### G) Completion + feedback prompts (shared semantics)
- Mutation logic: `lib/services/completion_mutations.dart`
- Feedback UI: `lib/widgets/dialogs/completion_feedback_sheet.dart`
- Implemented consistently across:
  - `lib/widgets/habit_tracker_sheet.dart`
  - `lib/screens/tasks_list_screen.dart`
  - `lib/widgets/dashboard/all_boards_tasks_tab.dart`
  - (habits) `lib/screens/habits_list_screen.dart`, `lib/widgets/dashboard/all_boards_habits_tab.dart`

---

## 13) Glossary (UI term → code type)

- Board:
  - `VisionBoardInfo` (`lib/models/vision_board_info.dart`) + persisted via `BoardsStorageService`
- Goal (general concept: something you attach habits/tasks to):
  - Freeform/goal canvas: usually an `ImageComponent` with `goal` metadata
  - Physical board: `GoalOverlayComponent`
  - Grid: `GridTileModel` (converted to `ImageComponent` for tracker UI)
- Layer:
  - A `VisionComponent` entry in the board’s components list (ordered by `zIndex`)
  - Managed via `showLayersSheet` in `lib/widgets/editor/layers_sheet.dart`
- Habit:
  - `HabitItem` (`lib/models/habit_item.dart`) stored on a goal’s component/tile
- Task:
  - `TaskItem` (`lib/models/task_item.dart`) stored on a goal’s component/tile
- Checklist item:
  - `ChecklistItem` (`lib/models/task_item.dart`)
  - Completion stored in `completedOn` (YYYY-MM-DD) and per-day feedback in `feedbackByDate`
- “Tracker”:
  - The per-goal tracking UI: `HabitTrackerSheet` (`lib/widgets/habit_tracker_sheet.dart`)
